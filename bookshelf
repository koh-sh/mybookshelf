#!/usr/bin/env python3
import csv
import argparse
from typing import List, Dict

class BookshelfManager:
    def __init__(self, csv_file='books.csv'):
        self.csv_file = csv_file
        
    def load_books(self) -> List[Dict]:
        """CSVから本のデータを読み込み"""
        try:
            with open(self.csv_file, 'r', encoding='utf-8') as f:
                return list(csv.DictReader(f))
        except FileNotFoundError:
            return []
    
    def save_books(self, books: List[Dict]):
        """本のデータをCSVに保存"""
        if not books:
            return
        
        fieldnames = ['NAME', 'CATEGORY', 'LANG', 'TYPE', 'STATUS', 'MEMO']
        with open(self.csv_file, 'w', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()
            writer.writerows(books)
    
    def add_book(self, name: str, category: str = "", lang: str = "JPN", 
                 book_type: str = "Kindle", status: str = "UNREAD", memo: str = ""):
        """本を追加"""
        books = self.load_books()
        
        # 重複チェック
        if any(book['NAME'] == name for book in books):
            print(f"エラー: '{name}' は既に登録されています")
            return False
        
        new_book = {
            'NAME': name,
            'CATEGORY': category,
            'LANG': lang,
            'TYPE': book_type,
            'STATUS': status,
            'MEMO': memo
        }
        
        books.append(new_book)
        self.save_books(books)
        print(f"追加しました: {name}")
        return True
    
    def update_status(self, name_part: str, new_status: str):
        """本のステータスを更新"""
        books = self.load_books()
        matches = [book for book in books if name_part.lower() in book['NAME'].lower()]
        
        if not matches:
            print(f"エラー: '{name_part}' を含む本が見つかりません")
            return False
        
        if len(matches) > 1:
            print(f"複数の本が見つかりました:")
            for i, book in enumerate(matches):
                print(f"  {i+1}. {book['NAME']}")
            return False
        
        matches[0]['STATUS'] = new_status
        self.save_books(books)
        print(f"更新しました: {matches[0]['NAME']} → {new_status}")
        return True
    
    def list_books(self, category: str = "", status: str = ""):
        """本の一覧表示"""
        books = self.load_books()
        
        if category:
            books = [book for book in books if book['CATEGORY'] == category]
        
        if status:
            books = [book for book in books if book['STATUS'] == status]
        
        if not books:
            print("該当する本がありません")
            return
        
        print(f"{'NAME':<50} {'CATEGORY':<20} {'STATUS':<10}")
        print("-" * 80)
        for book in books:
            print(f"{book['NAME']:<50} {book['CATEGORY']:<20} {book['STATUS']:<10}")
    
    def search_books(self, query: str):
        """本を検索"""
        books = self.load_books()
        matches = [book for book in books if query.lower() in book['NAME'].lower()]
        
        if not matches:
            print(f"'{query}' を含む本が見つかりません")
            return
        
        print(f"'{query}' の検索結果:")
        for book in matches:
            print(f"  {book['NAME']} ({book['CATEGORY']}, {book['STATUS']})")

def main():
    parser = argparse.ArgumentParser(description='Bookshelf CLI Tool')
    subparsers = parser.add_subparsers(dest='command', help='利用可能なコマンド')
    
    # add コマンド
    add_parser = subparsers.add_parser('add', help='本を追加')
    add_parser.add_argument('name', help='本のタイトル')
    add_parser.add_argument('--category', default='', help='カテゴリ')
    add_parser.add_argument('--lang', default='JPN', help='言語')
    add_parser.add_argument('--type', default='Kindle', help='本の種類')
    
    # start コマンド
    start_parser = subparsers.add_parser('start', help='読み始める (UNREAD → READING)')
    start_parser.add_argument('name', help='本のタイトル（部分一致）')
    
    # finish コマンド
    finish_parser = subparsers.add_parser('finish', help='読み終える (READING → READ)')
    finish_parser.add_argument('name', help='本のタイトル（部分一致）')
    
    # list コマンド
    list_parser = subparsers.add_parser('list', help='本の一覧表示')
    list_parser.add_argument('--category', help='カテゴリでフィルタ')
    list_parser.add_argument('--status', help='ステータスでフィルタ')
    
    # search コマンド
    search_parser = subparsers.add_parser('search', help='本を検索')
    search_parser.add_argument('query', help='検索クエリ')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    manager = BookshelfManager()
    
    if args.command == 'add':
        manager.add_book(args.name, args.category, args.lang, args.type)
    elif args.command == 'start':
        manager.update_status(args.name, 'READING')
    elif args.command == 'finish':
        manager.update_status(args.name, 'READ')
    elif args.command == 'list':
        manager.list_books(args.category, args.status)
    elif args.command == 'search':
        manager.search_books(args.query)

if __name__ == "__main__":
    main()